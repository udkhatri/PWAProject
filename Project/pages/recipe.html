<ons-page id="recipe">

  <script>  
  const options = {
	method: 'GET',
	headers: {
		'X-RapidAPI-Key': '8c3134a6e6msh40114e5b61fc300p13f380jsn0bc270040660',
		'X-RapidAPI-Host': 'spoonacular-recipe-food-nutrition-v1.p.rapidapi.com'
	}
};
const saveRecipe = (recipenumber, button) => {
      addRecipeToGrid(recipenumber);
      button.parentNode.parentNode.hideExpansion();
    };

    const appendRecipe = (recipenumber, title, image) => {
      const list = document.querySelector('#recipe-list');
      list.appendChild(ons.createElement(`
        <ons-list-item expandable>
          <img src=${image} style="width: 15%">
          ${recipenumber} ${title}
          <div class="expandable-content">
            <ons-button onclick="saveRecipe(${recipenumber}, this)">Save</ons-button>
          </div>
        </ons-list-item>
      `));
    }

    document.addEventListener('init', ({ target }) => {
      if (target.matches('#recipe')) {
        // local storage keys
        const URL = 'recipe__url';
        const PREFIX = 'recipe__';

        let nextRecipenumber = 1;
        let storedRecipe;
        let recipeImage;

        while ((storedRecipe = localStorage.getItem(PREFIX + nextRecipenumber)) !== null) {
          console.log(`got ${storedRecipe} from local with key ${PREFIX + nextRecipenumber}`);
          appendRecipe(nextRecipenumber, storedRecipe , recipeImage);
          nextRecipenumber++;
        }

        if (!localStorage.getItem(URL), options) {
          localStorage.setItem(URL, 'https://spoonacular-recipe-food-nutrition-v1.p.rapidapi.com/recipes/random');
        }

        const get = async () => {
          // do the API call and get JSON response
          const response = await fetch(localStorage.getItem(URL), options);
          const json = await response.json();

          const newRecipeTitle = json.recipes.map(e => e.title);
          const recipeImage = json.recipes.map(e => e.image)
          
          const list = document.querySelector('#recipe-list');
          newRecipeTitle.forEach((title, i) => {

            image = recipeImage[i];
            appendRecipe(nextRecipenumber, title , image);

            const key = PREFIX + nextRecipenumber;
            console.log(`Storing ${title} as ${key}`);
            localStorage.setItem(key, title)
            nextRecipenumber++;
          });

          //localStorage.setItem(URL, 'https://spoonacular-recipe-food-nutrition-v1.p.rapidapi.com/recipes/random');
          
          // hide the spinner when all the pages have been loaded
          if (!localStorage.getItem(URL), options) {
            document.querySelector('#after-list').style.display = 'none';
          }
        };

        // get the first set of results as soon as the page is initialised
        get();

        // at the bottom of the list get the next set of results and append them
        target.onInfiniteScroll = (done) => {
          if (!localStorage.getItem(URL), options) {
            setTimeout(() => {
              get();
              done();
            }, 200);
          }
        };
      }
    });

   
  </script>

  <ons-list id="recipe-list">
  </ons-list>

  <div id="after-list" style="margin: 20px; text-align: center;">
    <ons-icon icon="fa-spinner" size="26px" spin></ons-icon>
  </div>

</ons-page>