<ons-page id="recipe">

  <script>  
  const options = {
	method: 'GET',
	headers: {
		'X-RapidAPI-Key': '8c3134a6e6msh40114e5b61fc300p13f380jsn0bc270040660',
		'X-RapidAPI-Host': 'spoonacular-recipe-food-nutrition-v1.p.rapidapi.com'
	}
};
const saveRecipe = (recipenumber, button) => {
      addRecipeToGrid(recipenumber);
      button.parentNode.parentNode.hideExpansion();
    };

    const appendRecipe = (recipenumber, name, image) => {
      const list = document.querySelector('#recipe-list');
      list.appendChild(ons.createElement(`
        <ons-list-item expandable>
          <img src=${image} style="width: 15%">
          ${recipenumber} ${name}
          <div class="expandable-content">
            <ons-button onclick="saveRecipe(${recipenumber}, this)">Save</ons-button>
          </div>
        </ons-list-item>
      `));
    }

    document.addEventListener('init', ({ target }) => {
      if (target.matches('#recipe')) {
        // local storage keys
        const URL = 'recipe__url';
        const PREFIX = 'recipe__';

        let nextRecipenumber = 1;
        let storedRecipe;

        while ((storedRecipe = localStorage.getItem(PREFIX + nextRecipenumber)) !== null) {
          console.log(`got ${storedRecipe} from local with key ${PREFIX + nextRecipenumber}`);
          appendRecipe(nextRecipenumber, storedRecipe);
          nextRecipenumber++;
        }

        if (!localStorage.getItem(URL)) {
          localStorage.setItem(URL, 'https://spoonacular-recipe-food-nutrition-v1.p.rapidapi.com/recipes/random?number=3');
        }

        const get = async () => {
          // do the API call and get JSON response
          const response = await fetch(localStorage.getItem(URL), options);
          const json = await response.json();
          console.log(json);
          
          
          const newRecipe = json.recipes.map(e => e.title);
          const newRecipeImage = json.recipes.map(e => e.image)
          const myRecipe = json.recipes.map(e => e);
          console.log('My recipe 1 ' + JSON.stringify(myRecipe[1]));
          const list = document.querySelector('#recipe-list');
          newRecipe.forEach((name, i) => {
            image = newRecipeImage[i];
            console.log(image);
            if (image != undefined){
              appendRecipe(nextRecipenumber, name, image);

                const key = PREFIX + nextRecipenumber;
                console.log(`Storing ${name} as ${key}`);
                localStorage.setItem(key, name)
                nextRecipenumber++;
            }

            

          });

          localStorage.setItem(URL, json.next);

          // hide the spinner when all the pages have been loaded
          if (!localStorage.getItem(URL)) {
            document.querySelector('#after-list').style.display = 'none';
          }
        };

        // get the first set of results as soon as the page is initialised
        get();

        // at the bottom of the list get the next set of results and append them
        target.onInfiniteScroll = (done) => {
          if (localStorage.getItem(URL)) {
            setTimeout(() => {
              get();
              done();
            }, 200);
          }
        };
      }
    });
  </script>

  <ons-list id="recipe-list">
  </ons-list>

  <div id="after-list" style="margin: 20px; text-align: center;">
    <ons-icon icon="fa-spinner" size="26px" spin></ons-icon>
  </div>

</ons-page>